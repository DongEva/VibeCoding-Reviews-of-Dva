<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤å¤åƒç´ è´ªåƒè›‡ - æ°´æœå›¾é‰´ç‰ˆ</title>
    <!-- å¼•å…¥åƒç´ å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- é¢œè‰²è®¾ç½® --- */
            /* æ¸¸æˆæœºå¤–å£³ï¼šæ¢å¤ä¸ºåŸæ¥çš„ç°ç™½è‰² */
            --console-bg: #dcdcdc;
            --console-dark: #aaa;
            --dpad-color: #2b2b2b;
            --console-red: #e60012;
            --screen-bg: #8b9bb4;
            --screen-on: #9bbc0f;
            --pixel-color: #0f380f;
            
            /* --- ä¿¡æ¯é¢æ¿é¢œè‰² --- */
            --info-panel-bg: #e8e4d9;
            --info-lcd-bg: #cfd8dc;
            
            --shadow-light: rgba(255, 255, 255, 0.6);
            --shadow-dark: rgba(0, 0, 0, 0.4);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            height: 100vh;
            /* --- èƒŒæ™¯æ”¹ä¸ºç±³ç™½è‰² --- */
            background-color: #f4f0e6;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            overflow: auto; 
        }

        /* æ¸¸æˆæœºå¤–å£³ */
        .console-case {
            width: 100%;
            max-width: 750px; 
            background-color: var(--console-bg);
            border-radius: 20px 20px 40px 40px;
            padding: 20px;
            box-shadow: 
                inset 5px 5px 15px var(--shadow-light),
                inset -5px -5px 15px var(--shadow-dark),
                10px 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin: 20px 0;
        }

        .case-top-line {
            width: 60%;
            height: 10px;
            background: var(--console-dark);
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }

        /* --- é¡¶éƒ¨åŒºåŸŸï¼šåŒ…å«å±å¹•å’Œä¾§è¾¹æ  --- */
        .top-area {
            display: flex;
            gap: 15px;
            align-items: stretch; /* è®©ä¸¤ä¸ªç›’å­æ‹‰ä¼¸åˆ°ç›¸åŒé«˜åº¦ */
            justify-content: center;
            width: 100%;
            margin-bottom: 20px;
        }

        /* å±å¹•è¾¹æ¡†åŒºåŸŸ */
        .screen-bezel {
            background-color: #555;
            padding: 20px; /* ä¸Šä¸‹å·¦å³å„20px */
            border-radius: 10px 10px 30px 10px;
            box-shadow: 
                inset 2px 2px 5px rgba(0,0,0,0.5),
                5px 5px 10px rgba(0,0,0,0.3);
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .screen-container {
            position: relative;
            width: 320px;
            height: 352px; /* ä¿®æ”¹ï¼šå¢åŠ é«˜åº¦ä»¥å®¹çº³æ›´å¤šå†…å®¹ (22è¡Œæ ¼å­) */
            background-color: var(--screen-bg);
            border: 4px solid #444;
            box-shadow: inset 5px 5px 20px rgba(0,0,0,0.6);
            overflow: hidden;
        }

        /* --- å³ä¾§ä¿¡æ¯é¢æ¿ --- */
        .info-panel {
            width: 200px;
            /* ä¿®æ”¹ï¼šé«˜åº¦ = Bezel Padding(20+20) + Canvas(352) = 392px */
            height: 392px; 
            background-color: var(--info-panel-bg);
            border-radius: 10px;
            border: 2px solid #aaa;
            display: flex;
            flex-direction: column;
            /* ä¿®æ”¹ï¼šPaddingæ”¹ä¸º20pxä»¥åŒ¹é…å·¦ä¾§Bezel */
            padding: 20px; 
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
            /* ç¡®ä¿å†…å®¹ä»ä¸Šå¾€ä¸‹æ’ï¼Œåº•éƒ¨å¯¹é½ç”±é«˜åº¦æ§åˆ¶ */
            justify-content: flex-start; 
        }

        .panel-title {
            font-size: 10px;
            color: #555;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px dashed #999;
            width: 100%;
            padding-bottom: 5px;
            font-family: sans-serif;
            font-weight: bold;
        }

        .fruit-display-box {
            width: 80px;
            height: 80px;
            background-color: var(--info-lcd-bg);
            border: 2px solid #888;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            margin: 0 auto 15px auto; /* å±…ä¸­ */
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }
        
        .fruit-display-box.pop {
            transform: scale(1.1);
            border-color: #fff;
            box-shadow: 0 0 15px #9bbc0f, inset 2px 2px 5px rgba(0,0,0,0.1);
        }

        .text-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .fruit-label {
            font-size: 10px;
            color: #666;
            font-family: sans-serif;
            text-transform: uppercase;
        }

        .fruit-name {
            font-size: 11px;
            color: #333;
            font-weight: bold;
            font-family: sans-serif;
            text-align: left;
            background: #fff;
            padding: 4px;
            border-radius: 3px;
            border: 1px solid #ddd;
            min-height: 20px;
        }

        /* --- å›¾é‰´åŒºåŸŸ --- */
        .collection-title {
            font-size: 9px;
            color: #555;
            font-family: sans-serif;
            font-weight: bold;
            width: 100%;
            border-top: 1px dashed #bbb;
            padding-top: 8px;
            margin-bottom: 8px;
            text-align: left;
            flex-shrink: 0;
        }

        .collection-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4åˆ—å¸ƒå±€ */
            gap: 8px;
            width: 100%;
            flex-grow: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            align-content: start; /* å†…å®¹é ä¸Šï¼Œé˜²æ­¢æ‹‰ä¼¸ */
        }

        .collect-icon {
            font-size: 18px;
            text-align: center;
            cursor: default;
            transition: all 0.3s;
        }

        .collect-icon.uncollected {
            filter: grayscale(100%) brightness(0.4);
            opacity: 0.6;
        }

        .collect-icon.collected {
            filter: none;
            opacity: 1;
            transform: scale(1.1);
            text-shadow: 0 0 5px #fff;
        }

        /* --- å±å¹•å†…éƒ¨å†…å®¹ --- */
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--pixel-color);
            text-align: center;
            z-index: 20;
            background: rgba(155, 188, 15, 0.85);
            transition: opacity 0.3s;
        }
        .game-ui.hidden { opacity: 0; pointer-events: none; }
        .title { font-size: 1.2rem; margin-bottom: 20px; text-transform: uppercase; text-shadow: 2px 2px #fff; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* --- æ§åˆ¶åŒºåŸŸ --- */
        .controls-area {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        /* åå­—é”® */
        .d-pad { width: 120px; height: 120px; position: relative; }
        .d-pad-part {
            position: absolute;
            background-color: var(--dpad-color);
            cursor: pointer;
            box-shadow: inset 2px 2px 5px rgba(255,255,255,0.2), inset -2px -2px 5px rgba(0,0,0,0.5), 2px 2px 5px rgba(0,0,0,0.3);
            transition: background-color 0.1s, box-shadow 0.1s;
        }
        .d-pad-part:active, .d-pad-part.active {
            background-color: #1a1a1a;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.7);
        }
        .d-up { top: 0; left: 33.33%; width: 33.33%; height: 33.33%; border-radius: 5px 5px 0 0; z-index: 1; }
        .d-down { bottom: 0; left: 33.33%; width: 33.33%; height: 33.33%; border-radius: 0 0 5px 5px; z-index: 1; }
        .d-left { top: 33.33%; left: 0; width: 33.33%; height: 33.33%; border-radius: 5px 0 0 5px; z-index: 2; }
        .d-right { top: 33.33%; right: 0; width: 33.33%; height: 33.33%; border-radius: 0 5px 5px 0; z-index: 2; }
        .d-center {
            position: absolute;
            width: 33.33%;
            height: 33.33%;
            top: 33.33%;
            left: 33.33%;
            background: radial-gradient(circle, #444 20%, #222 100%);
            z-index: 5;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5);
            border-radius: 50%;
        }
        .d-pad-part::after {
            content: '';
            position: absolute;
            background: rgba(0,0,0,0.5);
        }
        .d-up::after { top: 5px; left: 35%; width: 30%; height: 3px; box-shadow: 0 4px 0 rgba(0,0,0,0.5); }
        .d-down::after { bottom: 5px; left: 35%; width: 30%; height: 3px; box-shadow: 0 -4px 0 rgba(0,0,0,0.5); }
        .d-left::after { left: 5px; top: 35%; height: 30%; width: 3px; box-shadow: 4px 0 0 rgba(0,0,0,0.5); }
        .d-right::after { right: 5px; top: 35%; height: 30%; width: 3px; box-shadow: -4px 0 0 rgba(0,0,0,0.5); }

        /* START æŒ‰é’® */
        .action-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px;
            width: 120px;
        }
        .btn-round {
            width: 60px;
            height: 60px;
            background-color: var(--console-red);
            border-radius: 50%;
            box-shadow: inset 3px 3px 8px var(--shadow-light), inset -3px -3px 8px var(--shadow-dark), 3px 3px 8px rgba(0,0,0,0.4);
            cursor: pointer;
            position: relative;
            transition: transform 0.1s;
        }
        .btn-round:active, .btn-round.active {
            box-shadow: inset 3px 3px 8px rgba(0,0,0,0.5);
            transform: scale(0.95);
            background-color: #c40010;
        }
        .btn-label {
            margin-top: 15px;
            color: #333;
            font-family: sans-serif;
            font-weight: 900;
            font-size: 12px;
            letter-spacing: 1px;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
        }

        /* è£…é¥° LOGO */
        .brand-logo {
            position: absolute;
            top: 25px;
            left: 30px;
            font-family: 'Press Start 2P', cursive;
            font-weight: normal;
            font-style: normal;
            color: rgba(0,0,0,0.2);
            font-size: 0.8rem;
            transform: none;
            pointer-events: none;
            white-space: nowrap;
            line-height: 1.5;
        }

        .speaker {
            position: absolute;
            bottom: 20px;
            right: 30px;
            display: grid;
            grid-template-columns: repeat(6, 4px);
            gap: 4px;
        }
        .speaker-hole {
            width: 4px;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 50%;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 600px) {
            .console-case { padding: 15px; }
            .top-area { flex-direction: column; gap: 10px; }
            .screen-container { 
                width: 100%; 
                max-width: 320px; 
                height: auto; 
                aspect-ratio: 320 / 352; /* ä¿æŒæ–°çš„æ¯”ä¾‹ */
            }
            .info-panel { 
                width: 100%; 
                height: auto; 
                flex-direction: row; 
                flex-wrap: wrap; 
                padding: 10px; 
                gap: 10px;
                /* æ‰‹æœºç«¯ä¸å†å¼ºåˆ¶ç­‰é«˜ */
            }
            
            .collection-title, .collection-grid { display: none; }
            
            .fruit-display-box { width: 60px; height: 60px; font-size: 30px; margin-bottom: 0; }
            .text-container { width: 60%; }
            .controls-area { padding: 0 10px; }
            .d-pad { width: 100px; height: 100px; }
            .btn-round { width: 50px; height: 50px; }
            .title { font-size: 1rem; }
            .brand-logo { font-size: 0.6rem; left: 20px; }
        }
    </style>
</head>
<body>

    <div class="console-case">
        <div class="case-top-line"></div>
        <div class="brand-logo">DongEvan Trial</div>
        
        <!-- é¡¶éƒ¨åŒºåŸŸï¼šå±å¹• + ä¾§è¾¹æ  -->
        <div class="top-area">
            <div class="screen-bezel">
                <div class="screen-container">
                    <canvas id="gameCanvas" width="320" height="352"></canvas>
                    <div class="scanlines"></div>
                    
                    <div id="startScreen" class="game-ui">
                        <div class="title">SNAKE GAME</div>
                        <div class="blink">PRESS START</div>
                    </div>

                    <!-- ç»“æœç•Œé¢ï¼ˆå¤ç”¨ï¼Œæ˜¾ç¤º GAME OVER æˆ– VICTORYï¼‰ -->
                    <div id="resultScreen" class="game-ui hidden">
                        <div class="title" id="result-title" style="color: #9b0000;">GAME OVER</div>
                        
                        <!-- èƒœåˆ©æ—¶æ‰æ˜¾ç¤ºæ—¶é—´ -->
                        <div id="time-display" style="display:none; margin: 10px 0; font-size: 0.8rem;">
                            TIME: <span id="finalTime">00:00:00</span>
                        </div>

                        <div>SCORE: <span id="finalScore">0</span></div>
                        <div class="blink" style="margin-top: 20px;">TRY AGAIN</div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ä¿¡æ¯æ  -->
            <div class="info-panel">
                <div class="panel-title">FRUIT INFO</div>
                <div class="fruit-display-box" id="fruit-icon-box">?</div>
                <div class="text-container">
                    <div>
                        <div class="fruit-label">CN ä¸­æ–‡</div>
                        <div class="fruit-name" id="fruit-cn">--</div>
                    </div>
                    <div>
                        <div class="fruit-label">ES EspaÃ±ol</div>
                        <div class="fruit-name" id="fruit-es">--</div>
                    </div>
                </div>

                <!-- å›¾é‰´åŒºåŸŸ -->
                <div class="collection-title">COLLECTION</div>
                <div class="collection-grid" id="pokedex-grid">
                    <!-- å›¾æ ‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨æ§åˆ¶åŒº -->
        <div class="controls-area">
            <div class="d-pad">
                <div class="d-center"></div>
                <div class="d-pad-part d-up" id="d-up"></div>
                <div class="d-pad-part d-down" id="d-down"></div>
                <div class="d-pad-part d-left" id="d-left"></div>
                <div class="d-pad-part d-right" id="d-right"></div>
            </div>

            <div class="action-area">
                <div class="btn-round" id="btn-start"></div>
                <div class="btn-label">START</div>
            </div>
        </div>

        <div class="speaker">
            <div class="speaker-hole"></div><div class="speaker-hole"></div><div class="speaker-hole"></div>
            <div class="speaker-hole"></div><div class="speaker-hole"></div><div class="speaker-hole"></div>
            <div class="speaker-hole"></div><div class="speaker-hole"></div><div class="speaker-hole"></div>
            <div class="speaker-hole"></div><div class="speaker-hole"></div><div class="speaker-hole"></div>
            <div class="speaker-hole"></div><div class="speaker-hole"></div><div class="speaker-hole"></div>
            <div class="speaker-hole"></div><div class="speaker-hole"></div><div class="speaker-hole"></div>
        </div>
    </div>

    <script>
        // --- æ°´æœæ•°æ®åº“ ---
        const FRUITS = [
            { icon: 'ğŸ', cn: 'è‹¹æœ', es: 'Manzana' },
            { icon: 'ğŸŒ', cn: 'é¦™è•‰', es: 'PlÃ¡tano' },
            { icon: 'ğŸ‡', cn: 'è‘¡è„', es: 'Uva' },
            { icon: 'ğŸ‰', cn: 'è¥¿ç“œ', es: 'SandÃ­a' },
            { icon: 'ğŸ“', cn: 'è‰è“', es: 'Fresa' },
            { icon: 'ğŸ’', cn: 'æ¨±æ¡ƒ', es: 'Cereza' },
            { icon: 'ğŸ‘', cn: 'æ¡ƒå­', es: 'MelocotÃ³n' },
            { icon: 'ğŸŠ', cn: 'æ©˜å­', es: 'Naranja' },
            { icon: 'ğŸ', cn: 'è è', es: 'PiÃ±a' },
            { icon: 'ğŸ¥', cn: 'çŒ•çŒ´æ¡ƒ', es: 'Kiwi' },
            { icon: 'ğŸ', cn: 'æ¢¨', es: 'Pera' },
            { icon: 'ğŸ‹', cn: 'æŸ æª¬', es: 'LimÃ³n' }
        ];

        // --- æ¸¸æˆé…ç½® ---
        const CANVAS_WIDTH = 320;
        const CANVAS_HEIGHT = 352; // ä¿®æ”¹ï¼šå¢åŠ é«˜åº¦ (22è¡Œ)
        const GRID_SIZE = 16; 
        const TILE_COUNT_X = CANVAS_WIDTH / GRID_SIZE;
        const TILE_COUNT_Y = CANVAS_HEIGHT / GRID_SIZE; 
        const FPS = 10; 

        // --- DOM å…ƒç´  ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const resultScreen = document.getElementById('resultScreen');
        const resultTitle = document.getElementById('result-title');
        const timeDisplay = document.getElementById('time-display');
        const finalTimeEl = document.getElementById('finalTime');
        const finalScoreEl = document.getElementById('finalScore');
        const btnStart = document.getElementById('btn-start');
        
        // å³ä¾§é¢æ¿å…ƒç´ 
        const fruitIconBox = document.getElementById('fruit-icon-box');
        const fruitCnEl = document.getElementById('fruit-cn');
        const fruitEsEl = document.getElementById('fruit-es');
        const pokedexGrid = document.getElementById('pokedex-grid');

        // åå­—é”®æŒ‰é’®
        const dUp = document.getElementById('d-up');
        const dDown = document.getElementById('d-down');
        const dLeft = document.getElementById('d-left');
        const dRight = document.getElementById('d-right');

        // --- éŸ³é¢‘ ---
        let audioCtx = null;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            if (type === 'move') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.05);
            } else if (type === 'eat') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.setValueAtTime(600, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.2);
            } else if (type === 'win') {
                // èƒœåˆ©éŸ³æ•ˆï¼šå¤§ä¸‰å’Œå¼¦
                const now = audioCtx.currentTime;
                [523.25, 659.25, 783.99].forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.type = 'square';
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.frequency.setValueAtTime(freq, now + i * 0.1);
                    g.gain.setValueAtTime(0.1, now + i * 0.1);
                    g.gain.linearRampToValueAtTime(0, now + i * 0.1 + 0.3);
                    o.start(now + i * 0.1);
                    o.stop(now + i * 0.1 + 0.3);
                });
            } else if (type === 'die') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            }
        }

        // --- æ¸¸æˆçŠ¶æ€ ---
        let snake = [];
        let food = { x: 0, y: 0, type: null }; 
        let velocity = { x: 0, y: 0 };
        let nextVelocity = { x: 0, y: 0 }; 
        let score = 0;
        let gameInterval = null;
        let isGameRunning = false;
        
        // æ”¶é›†è®°å½• & è®¡æ—¶
        let collectedFruits = new Set();
        let startTime = 0;

        // --- ç»˜å›¾å‡½æ•° ---
        function drawPixelRect(x, y, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x * GRID_SIZE + 1, y * GRID_SIZE + 1, GRID_SIZE - 2, GRID_SIZE - 2);
        }

        function drawSnake() {
            snake.forEach((segment, index) => {
                const color = index === 0 ? '#0f380f' : '#306230';
                drawPixelRect(segment.x, segment.y, color);
            });
        }

        function drawFood() {
            ctx.font = '14px "Segoe UI Emoji", Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const centerX = food.x * GRID_SIZE + GRID_SIZE / 2;
            const centerY = food.y * GRID_SIZE + GRID_SIZE / 2 + 1; 
            ctx.fillText(food.type.icon, centerX, centerY);
        }

        function drawScore() {
            ctx.fillStyle = '#0f380f';
            ctx.font = '10px "Press Start 2P"';
            ctx.fillText(`SCORE:${score}`, 5, CANVAS_HEIGHT - 5);
        }

        function draw() {
            ctx.fillStyle = '#9bbc0f';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            drawFood();
            drawSnake();
            drawScore();
        }

        function spawnFood() {
            let valid = false;
            while (!valid) {
                const x = Math.floor(Math.random() * TILE_COUNT_X);
                const y = Math.floor(Math.random() * TILE_COUNT_Y);
                const onSnake = snake.some(segment => segment.x === x && segment.y === y);
                if (!onSnake) {
                    food.x = x;
                    food.y = y;
                    food.type = FRUITS[Math.floor(Math.random() * FRUITS.length)];
                    valid = true;
                }
            }
        }

        // --- åˆå§‹åŒ–å›¾é‰´ ---
        function initPokedex() {
            pokedexGrid.innerHTML = '';
            FRUITS.forEach(fruit => {
                const div = document.createElement('div');
                div.className = 'collect-icon uncollected';
                div.innerText = fruit.icon;
                div.id = 'pokedex-' + fruit.icon;
                div.title = `${fruit.cn} / ${fruit.es}`;
                pokedexGrid.appendChild(div);
            });
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            const millis = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
            return `${minutes}:${seconds}:${millis}`;
        }

        function updateInfoPanel(fruitData) {
            fruitIconBox.innerText = fruitData.icon;
            fruitCnEl.innerText = fruitData.cn;
            fruitEsEl.innerText = fruitData.es;

            // æ’­æ”¾åŠ¨ç”»
            fruitIconBox.classList.remove('pop');
            void fruitIconBox.offsetWidth; 
            fruitIconBox.classList.add('pop');

            // æ›´æ–°å›¾é‰´çŠ¶æ€
            const iconId = 'pokedex-' + fruitData.icon;
            const iconEl = document.getElementById(iconId);
            
            if (iconEl && iconEl.classList.contains('uncollected')) {
                collectedFruits.add(fruitData.icon);
                iconEl.classList.remove('uncollected');
                iconEl.classList.add('collected');
                
                // --- èƒœåˆ©åˆ¤æ–­ ---
                if (collectedFruits.size === FRUITS.length) {
                    victory();
                }
            }
        }

        function update() {
            if (!isGameRunning) return;

            velocity = { ...nextVelocity };
            const head = { x: snake[0].x + velocity.x, y: snake[0].y + velocity.y };

            if (head.x < 0 || head.x >= TILE_COUNT_X || head.y < 0 || head.y >= TILE_COUNT_Y) {
                gameOver();
                return;
            }
            if (snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                gameOver();
                return;
            }

            snake.unshift(head);

            if (head.x === food.x && head.y === food.y) {
                score += 10;
                playSound('eat');
                updateInfoPanel(food.type);
                spawnFood();
            } else {
                snake.pop();
            }
        }

        function gameLoop() {
            update();
            draw();
        }

        function startGame() {
            initAudio();
            snake = [{ x: 10, y: 10 }, { x: 9, y: 10 }, { x: 8, y: 10 }];
            velocity = { x: 1, y: 0 };
            nextVelocity = { x: 1, y: 0 };
            score = 0;
            isGameRunning = true;
            
            collectedFruits.clear();
            initPokedex();

            startTime = Date.now();
            
            fruitIconBox.innerText = "?";
            fruitCnEl.innerText = "--";
            fruitEsEl.innerText = "--";

            spawnFood();
            
            startScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, 1000 / FPS);
            playSound('move');
        }

        function gameOver() {
            isGameRunning = false;
            clearInterval(gameInterval);
            playSound('die');
            
            resultTitle.innerText = "GAME OVER";
            resultTitle.style.color = "#9b0000";
            timeDisplay.style.display = "none";
            finalScoreEl.innerText = score;
            resultScreen.classList.remove('hidden');
        }

        function victory() {
            isGameRunning = false;
            clearInterval(gameInterval);
            playSound('win');
            
            const endTime = Date.now();
            const duration = endTime - startTime;

            resultTitle.innerText = "VICTORY!";
            resultTitle.style.color = "#0f380f";
            timeDisplay.style.display = "block";
            finalTimeEl.innerText = formatTime(duration);
            finalScoreEl.innerText = score;
            
            resultScreen.classList.remove('hidden');
        }

        function handleInput(action) {
            if (!isGameRunning) return;
            switch(action) {
                case 'UP': if (velocity.y === 0) nextVelocity = { x: 0, y: -1 }; break;
                case 'DOWN': if (velocity.y === 0) nextVelocity = { x: 0, y: 1 }; break;
                case 'LEFT': if (velocity.x === 0) nextVelocity = { x: -1, y: 0 }; break;
                case 'RIGHT': if (velocity.x === 0) nextVelocity = { x: 1, y: 0 }; break;
            }
        }

        // é”®ç›˜ç›‘å¬
        document.addEventListener('keydown', (e) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) e.preventDefault();
            if (!isGameRunning && (e.key === 'Enter' || e.key === ' ')) { startGame(); return; }
            switch(e.key) {
                case 'ArrowUp': handleInput('UP'); dUp.classList.add('active'); break;
                case 'ArrowDown': handleInput('DOWN'); dDown.classList.add('active'); break;
                case 'ArrowLeft': handleInput('LEFT'); dLeft.classList.add('active'); break;
                case 'ArrowRight': handleInput('RIGHT'); dRight.classList.add('active'); break;
            }
        });

        document.addEventListener('keyup', () => {
            dUp.classList.remove('active');
            dDown.classList.remove('active');
            dLeft.classList.remove('active');
            dRight.classList.remove('active');
        });

        function bindBtn(btn, action) {
            btn.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                handleInput(action);
                btn.classList.add('active');
            });
            btn.addEventListener('pointerup', () => btn.classList.remove('active'));
            btn.addEventListener('pointerleave', () => btn.classList.remove('active'));
        }

        bindBtn(dUp, 'UP');
        bindBtn(dDown, 'DOWN');
        bindBtn(dLeft, 'LEFT');
        bindBtn(dRight, 'RIGHT');

        btnStart.addEventListener('click', () => { if (!isGameRunning) startGame(); });
        btnStart.addEventListener('pointerdown', () => btnStart.classList.add('active'));
        btnStart.addEventListener('pointerup', () => btnStart.classList.remove('active'));
        btnStart.addEventListener('pointerleave', () => btnStart.classList.remove('active'));

        // åˆå§‹åŒ–
        initPokedex();
        ctx.fillStyle = '#9bbc0f';
        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    </script>
</body>
</html>